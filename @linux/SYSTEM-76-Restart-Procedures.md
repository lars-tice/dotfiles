# System76 Thelio — Post-Update Restart Procedures

## Host: larsbox
- **OS**: Ubuntu 24.04 LTS (Noble Numbat) with Pop!_OS kernels
- **GPU**: NVIDIA (out-of-tree driver, DKMS-managed)
- **Display Manager**: GDM3 / GNOME / X.Org

## Known Issue

After kernel updates, the NVIDIA framebuffer handoff can fail silently — the system boots fully (services running, GDM active) but the display receives no signal. This has occurred multiple times. **The system is not frozen — it just has no display output.**

Hard power-cycling in this state is destructive and unnecessary. SSH in from another device instead.

## Pre-Reboot Checklist

```bash
# 1. Apply updates
sudo apt update && sudo apt upgrade

# 2. Check if reboot is required and what triggered it
cat /var/run/reboot-required
cat /var/run/reboot-required.pkgs

# 3. If a kernel update was included, verify DKMS built the
#    NVIDIA module for the NEW kernel BEFORE rebooting
dkms status
# Expected: nvidia/580.x, <new-kernel-version>, x86_64: installed
#
# If the new kernel is missing from dkms output:
sudo dkms autoinstall

# 4. Verify SSH and Cloudflare tunnel services are healthy
#    (these are your lifeline if the display doesn't come back)
systemctl is-enabled ssh.service
systemctl is-enabled cloudflared.service
systemctl status ssh.service --no-pager
systemctl status cloudflared.service --no-pager
# Both must show "enabled" and "active (running)".
# If either is not enabled:
#   sudo systemctl enable ssh.service
#   sudo systemctl enable cloudflared.service

# 5. Reboot
sudo reboot
```

## Post-Reboot Recovery (No Display Signal)

**Do NOT hard power-off.** The system is almost certainly running.

### Option A: SSH via Cloudflare Tunnel from MacBook Pro (preferred)

SSH to larsbox is tunneled through Cloudflare. You **cannot** connect directly
by IP — you must use `cloudflared` on the client side.

**Prerequisites on your MacBook Pro:**
- `cloudflared` installed (via `brew install cloudflared` or the dotfiles playbook)
- SSH config entry for `ssh.firstovertheline.com` (generated by the dotfiles
  playbook with `--extra-vars "cloudflared_ssh_hostname=ssh.firstovertheline.com"`)

```bash
# 1. SSH in (wait ~2 minutes after reboot for services to start)
ssh ssh.firstovertheline.com

# 2. Verify the system is running
systemctl is-system-running
systemctl status gdm3
nvidia-smi

# 3. Restart the display manager
sudo systemctl restart gdm3

# 4. If display still has no signal, reload the NVIDIA driver stack
sudo rmmod nvidia_drm nvidia_modeset nvidia_uvm nvidia
sudo modprobe nvidia
sudo systemctl restart gdm3

# 5. If still no display, do a CLEAN reboot (not hard power-off)
sudo reboot
# The second clean reboot typically resolves the framebuffer handoff.
# Wait 2 minutes, then repeat from step 1.
```

**If SSH connection is refused:** Both `ssh.service` and `cloudflared.service`
must be running on larsbox. If they didn't start (e.g., the boot failed before
systemd reached them), SSH won't work — fall back to Option B.

### Option B: Blind TTY login (no second device available)

If you don't have another device for SSH:

```
1. Press Ctrl+Alt+F3 (switches to text TTY — may work even
   when the graphical framebuffer doesn't)
2. Wait 5 seconds
3. Type your username, press Enter
4. Type your password, press Enter
5. Run: sudo systemctl restart gdm3
6. Press Ctrl+Alt+F1 to switch back to graphical display
```

### Option C: Last resort — clean shutdown

If neither SSH nor TTY produces results after two attempts:

```bash
# From SSH:
sudo shutdown -h now
# Wait 30 seconds after power LED goes off, then power on.
# A full cold start resets GPU firmware state, which is different
# from a warm reboot.
```

## Why This Happens

The NVIDIA out-of-tree kernel module uses DKMS to rebuild against each new kernel. During boot, the display pipeline transitions from an early `simple-framebuffer` to the NVIDIA DRM driver. This handoff is timing-sensitive and can fail silently on newer kernels (especially major version jumps like 6.17 → 6.18), leaving the GPU initialized but not producing output to the display.

The system itself is fully functional — GDM starts, services run, the login greeter loads — the monitor just has no signal.

## Incident History

| Date       | Kernel Change              | Boots to Recovery | Notes                                    |
|------------|----------------------------|-------------------|------------------------------------------|
| 2026-02-21 | 6.17.9 → 6.18.7           | 3+ (2 recorded)   | NVIDIA 580.82→580.126 realignment; unrecorded boots didn't reach journald |

## SSH Infrastructure

SSH access to larsbox uses a **Cloudflare Tunnel** (`a4c-k3s-tunnel`), not direct network connectivity.

| Component | Location | Service |
|-----------|----------|---------|
| SSH server | larsbox | `ssh.service` (port 22, enabled) |
| Cloudflare tunnel | larsbox | `cloudflared.service` (enabled, config: `/etc/cloudflared/config.yml`) |
| Tunnel ingress | Cloudflare edge | `ssh.firstovertheline.com` → `ssh://192.168.122.1:22` |
| Client proxy | MacBook Pro | `cloudflared` (installed via brew / dotfiles playbook) |

**Tunnel name**: `a4c-k3s-tunnel`
**Connect command**: `ssh ssh.firstovertheline.com`

Both `ssh.service` and `cloudflared.service` are `enabled` in systemd, so they
start automatically on boot. If the system reaches `multi-user.target`, SSH
access should be available even without a working display.

## Reference

- Baseline snapshot: `~/system-baseline-20260221-105501/`
- Comparison script: `~/system-baseline-20260221-105501/compare.sh`
- Journal from baseline cursor: `journalctl --after-cursor="$(cat ~/system-baseline-20260221-105501/journal-cursor.txt)"`
